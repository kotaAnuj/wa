<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>Person Follower Bot</title>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:Arial,sans-serif;background:#000;color:#fff;overflow:hidden;touch-action:none}
#app{display:flex;flex-direction:column;height:100vh}
#top{padding:10px;background:#111;border-bottom:2px solid #0f0}
#top h2{font-size:18px;margin-bottom:8px;color:#0f0}
.row{display:flex;gap:8px;margin:5px 0;align-items:center}
input{flex:1;padding:10px;font-size:16px;background:#222;color:#0f0;border:1px solid #0a0;border-radius:4px}
button{padding:10px 15px;font-size:14px;font-weight:bold;background:#0a0;color:#000;border:none;border-radius:4px;cursor:pointer}
button:active{background:#0f0}
button:disabled{opacity:0.3}
.info{font-size:13px;color:#0f0;margin:3px 0}
#videoBox{flex:1;position:relative;display:flex;justify-content:center;align-items:center;background:#000}
video{display:none}
canvas{max-width:100%;max-height:100%;border:2px solid #0a0}
#cmdBig{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,200,0,0.95);color:#000;padding:30px 50px;border-radius:15px;font-size:48px;font-weight:bold;border:4px solid #0f0;box-shadow:0 0 40px #0f0;pointer-events:none;z-index:10}
#status{position:absolute;top:10px;left:10px;background:rgba(0,0,0,0.8);padding:10px;border-radius:6px;font-size:12px;border:1px solid #0a0}
#status div{margin:3px 0}
#cmdPanel{position:absolute;bottom:10px;left:10px;right:10px;background:rgba(0,0,0,0.9);padding:15px;border-radius:8px;border:2px solid #0a0;max-height:200px;overflow-y:auto}
#cmdPanel h3{font-size:16px;color:#0f0;margin-bottom:8px}
.cmdLog{font-size:13px;margin:4px 0;padding:6px;background:#001a00;border-radius:4px;border-left:3px solid #0a0}
.cmdLog.active{background:#0a0;color:#000;font-weight:bold;animation:pulse 0.5s}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
.st{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:5px}
.st.on{background:#0f0}
.st.off{background:#f00}
</style>
</head>
<body>
<div id="app">
<div id="top">
<h2>ü§ñ Person Following Bot</h2>
<div class="row">
<input id="espIP" type="text" placeholder="ESP32 IP (192.168.x.x)" value="192.168.43.104">
<button onclick="connectESP()" id="connBtn">Connect</button>
</div>
<div class="row">
<button onclick="startCamera()" id="camBtn">Start Camera</button>
<button onclick="toggleTracking()" id="trkBtn" disabled>Start Tracking</button>
<button onclick="stopAll()" class="btn-stop" style="background:#a00">STOP ALL</button>
</div>
<div class="info">
<span class="st" id="espSt"></span>ESP: <span id="espTxt">Disconnected</span> | 
<span class="st" id="camSt"></span>Cam: <span id="camTxt">Off</span> | 
<span class="st" id="trkSt"></span>Track: <span id="trkTxt">Off</span> | 
FPS: <span id="fps">0</span>
</div>
</div>

<div id="videoBox">
<video id="video" autoplay playsinline></video>
<canvas id="canvas"></canvas>
<div id="cmdBig">READY</div>
<div id="status">
<div><b>Person Detection:</b> <span id="personSt">Waiting...</span></div>
<div><b>Commands Sent:</b> <span id="cmdCnt">0</span></div>
<div><b>Distance:</b> <span id="dist">-</span> cm</div>
</div>
<div id="cmdPanel">
<h3>üì° Command Stream (Live)</h3>
<div id="cmdList"></div>
</div>
</div>
</div>

<script>
let video,canvas,ctx,pose,camera,isTracking=false,espIP='',espConnected=false;
let path=[],lastPos=null,frameCount=0,lastTime=Date.now();
let commandCount=0,lastCommand='READY',lastCommandTime=0,lastSendTime=0;
let cameraActive=false,poseReady=false;

const config={
  driveSpeed:60,
  steerSpeed:70,
  threshold:45,
  updateRate:120,
  minMovement:30
};

function log(msg,isCmd=false){
  const list=document.getElementById('cmdList');
  const div=document.createElement('div');
  div.className='cmdLog'+(isCmd?' active':'');
  div.textContent=`[${new Date().toLocaleTimeString()}] ${msg}`;
  list.insertBefore(div,list.firstChild);
  if(list.children.length>20)list.removeChild(list.lastChild);
  setTimeout(()=>div.classList.remove('active'),500);
}

function updateUI(){
  document.getElementById('espSt').className='st '+(espConnected?'on':'off');
  document.getElementById('camSt').className='st '+(cameraActive?'on':'off');
  document.getElementById('trkSt').className='st '+(isTracking?'on':'off');
  document.getElementById('espTxt').textContent=espConnected?'Connected':'Disconnected';
  document.getElementById('camTxt').textContent=cameraActive?'Active':'Off';
  document.getElementById('trkTxt').textContent=isTracking?'TRACKING':'Off';
}

async function connectESP(){
  espIP=document.getElementById('espIP').value.trim();
  if(!espIP){
    alert('‚ùå Enter ESP32 IP address!');
    return;
  }
  
  document.getElementById('connBtn').disabled=true;
  document.getElementById('connBtn').textContent='Connecting...';
  
  try{
    const response=await fetch(`http://${espIP}/status`,{timeout:3000});
    const data=await response.json();
    espConnected=true;
    updateUI();
    log('‚úÖ ESP32 Connected! Distance: '+data.distance+'cm');
    document.getElementById('connBtn').textContent='Connected';
    document.getElementById('dist').textContent=data.distance.toFixed(1);
  }catch(err){
    espConnected=false;
    updateUI();
    log('‚ùå Connection Failed: '+err.message);
    alert('‚ùå Failed to connect!\n\n1. Check IP address\n2. ESP32 powered ON?\n3. Same WiFi network?');
    document.getElementById('connBtn').disabled=false;
    document.getElementById('connBtn').textContent='Retry';
  }
}

async function sendCommand(drive,steer){
  if(!espConnected||!espIP)return false;
  
  const now=Date.now();
  if(now-lastSendTime<config.updateRate)return false;
  lastSendTime=now;
  
  try{
    fetch(`http://${espIP}/control?drive=${drive}&steer=${steer}`,{
      method:'GET',
      mode:'no-cors'
    }).catch(()=>{});
    
    commandCount++;
    document.getElementById('cmdCnt').textContent=commandCount;
    return true;
  }catch(err){
    log('‚ùå Send error: '+err.message);
    return false;
  }
}

async function init(){
  video=document.getElementById('video');
  canvas=document.getElementById('canvas');
  ctx=canvas.getContext('2d');
  
  pose=new Pose({
    locateFile:(file)=>`https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`
  });
  
  pose.setOptions({
    modelComplexity:0,
    smoothLandmarks:true,
    minDetectionConfidence:0.5,
    minTrackingConfidence:0.5
  });
  
  pose.onResults(onPoseResults);
  poseReady=true;
  log('‚úÖ Pose detection model loaded');
}

async function startCamera(){
  if(cameraActive)return;
  
  document.getElementById('camBtn').disabled=true;
  document.getElementById('camBtn').textContent='Starting...';
  
  try{
    const stream=await navigator.mediaDevices.getUserMedia({
      video:{
        width:{ideal:640},
        height:{ideal:480},
        facingMode:'user'
      },
      audio:false
    });
    
    video.srcObject=stream;
    
    await new Promise(resolve=>{
      video.onloadedmetadata=()=>{
        canvas.width=video.videoWidth;
        canvas.height=video.videoHeight;
        resolve();
      };
    });
    
    await video.play();
    
    camera=new Camera(video,{
      onFrame:async()=>{
        if(pose&&poseReady){
          await pose.send({image:video});
        }
      },
      width:640,
      height:480
    });
    
    await camera.start();
    
    cameraActive=true;
    updateUI();
    document.getElementById('camBtn').textContent='Camera ON';
    document.getElementById('trkBtn').disabled=false;
    log('‚úÖ Camera started successfully');
    
  }catch(err){
    cameraActive=false;
    updateUI();
    log('‚ùå Camera error: '+err.message);
    alert('‚ùå Camera Error!\n\n1. Allow camera permission\n2. Check camera is working\n3. Refresh page and try again');
    document.getElementById('camBtn').disabled=false;
    document.getElementById('camBtn').textContent='Retry Camera';
  }
}

function toggleTracking(){
  if(!espConnected){
    alert('‚ùå Connect to ESP32 first!');
    return;
  }
  
  if(!cameraActive){
    alert('‚ùå Start camera first!');
    return;
  }
  
  isTracking=!isTracking;
  
  if(isTracking){
    document.getElementById('trkBtn').textContent='Stop Tracking';
    document.getElementById('trkBtn').style.background='#f00';
    document.getElementById('cmdBig').textContent='TRACKING...';
    log('üéØ TRACKING STARTED - Bot will follow person');
  }else{
    document.getElementById('trkBtn').textContent='Start Tracking';
    document.getElementById('trkBtn').style.background='#0a0';
    document.getElementById('cmdBig').textContent='STOPPED';
    sendCommand(0,0);
    log('‚èπÔ∏è Tracking stopped');
  }
  
  updateUI();
}

function stopAll(){
  isTracking=false;
  sendCommand(0,0);
  document.getElementById('cmdBig').textContent='STOPPED';
  document.getElementById('trkBtn').textContent='Start Tracking';
  document.getElementById('trkBtn').style.background='#0a0';
  updateUI();
  log('üõë EMERGENCY STOP');
}

function onPoseResults(results){
  if(!canvas||!ctx)return;
  
  ctx.save();
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(results.image,0,0,canvas.width,canvas.height);
  
  if(results.poseLandmarks){
    const landmarks=results.poseLandmarks;
    const leftHip=landmarks[23];
    const rightHip=landmarks[24];
    const nose=landmarks[0];
    
    if(leftHip&&rightHip){
      const centerX=(leftHip.x+rightHip.x)/2*canvas.width;
      const centerY=(leftHip.y+rightHip.y)/2*canvas.height;
      const currentPos={x:centerX,y:centerY};
      
      document.getElementById('personSt').textContent='‚úÖ Person Detected at ('+Math.round(centerX)+','+Math.round(centerY)+')';
      document.getElementById('personSt').style.color='#0f0';
      
      if(isTracking){
        const screenCenterX=canvas.width/2;
        const screenCenterY=canvas.height/2;
        
        const deltaX=currentPos.x-screenCenterX;
        const deltaY=currentPos.y-screenCenterY;
        
        const distance=Math.sqrt(deltaX*deltaX+deltaY*deltaY);
        
        const xRatio=deltaX/canvas.width;
        const yRatio=deltaY/canvas.height;
        
        path.push({x1:screenCenterX,y1:screenCenterY,x2:currentPos.x,y2:currentPos.y});
        if(path.length>80)path.shift();
        
        const now=Date.now();
        if(now-lastCommandTime>config.updateRate){
          
          let command='';
          let drive=0,steer=0;
          
          const xThreshold=canvas.width*0.15;
          const yThreshold=canvas.height*0.15;
          
          if(Math.abs(deltaX)>xThreshold||Math.abs(deltaY)>yThreshold){
            
            if(Math.abs(xRatio)>Math.abs(yRatio)){
              if(deltaX>xThreshold){
                command='RIGHT';
                steer=Math.min(100,Math.round(Math.abs(xRatio)*config.steerSpeed*2));
                drive=config.driveSpeed/2;
              }else if(deltaX<-xThreshold){
                command='LEFT';
                steer=-Math.min(100,Math.round(Math.abs(xRatio)*config.steerSpeed*2));
                drive=config.driveSpeed/2;
              }
            }else{
              if(deltaY>yThreshold){
                command='FRONT';
                drive=Math.min(100,Math.round(Math.abs(yRatio)*config.driveSpeed*1.5));
                steer=0;
              }else if(deltaY<-yThreshold){
                command='BACK';
                drive=-Math.min(100,Math.round(Math.abs(yRatio)*config.driveSpeed*1.5));
                steer=0;
              }
            }
            
            if(command){
              const sent=sendCommand(drive,steer);
              if(sent){
                lastCommand=command;
                lastCommandTime=now;
                document.getElementById('cmdBig').textContent=command;
                log(`‚û§ ${command} | D:${drive} S:${steer} | Dist:${Math.round(distance)}px | Ratio X:${xRatio.toFixed(2)} Y:${yRatio.toFixed(2)}`,true);
              }
            }
          }else{
            if(lastCommand!=='CENTERED'&&distance<100){
              sendCommand(0,0);
              lastCommand='CENTERED';
              document.getElementById('cmdBig').textContent='CENTERED';
              log('‚úì Person centered - Distance:'+Math.round(distance)+'px',true);
            }
          }
        }
      }
      
      lastPos=currentPos;
      
      const screenCenterX=canvas.width/2;
      const screenCenterY=canvas.height/2;
      
      ctx.strokeStyle='#f00';
      ctx.lineWidth=2;
      ctx.setLineDash([5,5]);
      ctx.beginPath();
      ctx.moveTo(0,screenCenterY);
      ctx.lineTo(canvas.width,screenCenterY);
      ctx.moveTo(screenCenterX,0);
      ctx.lineTo(screenCenterX,canvas.height);
      ctx.stroke();
      ctx.setLineDash([]);
      
      ctx.beginPath();
      ctx.arc(screenCenterX,screenCenterY,10,0,2*Math.PI);
      ctx.strokeStyle='#f00';
      ctx.lineWidth=2;
      ctx.stroke();
      
      ctx.strokeStyle='#ff0';
      ctx.lineWidth=3;
      ctx.beginPath();
      ctx.moveTo(screenCenterX,screenCenterY);
      ctx.lineTo(centerX,centerY);
      ctx.stroke();
      
      drawPath();
      
      ctx.beginPath();
      ctx.arc(centerX,centerY,20,0,2*Math.PI);
      ctx.fillStyle='rgba(0,255,0,0.5)';
      ctx.fill();
      ctx.strokeStyle='#0f0';
      ctx.lineWidth=4;
      ctx.stroke();
      
      ctx.font='bold 20px Arial';
      ctx.fillStyle='#0f0';
      ctx.strokeStyle='#000';
      ctx.lineWidth=3;
      ctx.strokeText('PERSON',centerX-45,centerY-30);
      ctx.fillText('PERSON',centerX-45,centerY-30);
      
      const deltaX=Math.round(centerX-screenCenterX);
      const deltaY=Math.round(centerY-screenCenterY);
      const dist=Math.round(Math.sqrt(deltaX*deltaX+deltaY*deltaY));
      
      ctx.font='12px Arial';
      ctx.fillStyle='#ff0';
      ctx.fillText(`ŒîX:${deltaX} ŒîY:${deltaY}`,centerX-40,centerY+40);
      ctx.fillText(`Dist:${dist}px`,centerX-40,centerY+55);
      
    }else{
      document.getElementById('personSt').textContent='‚ùå No Person Detected';
      document.getElementById('personSt').style.color='#f00';
    }
    
    drawConnectors(ctx,landmarks,POSE_CONNECTIONS,{
      color:'rgba(0,255,0,0.3)',
      lineWidth:2
    });
    drawLandmarks(ctx,landmarks,{
      color:'rgba(0,255,255,0.4)',
      lineWidth:1,
      radius:3
    });
  }else{
    document.getElementById('personSt').textContent='‚ö†Ô∏è Waiting for person...';
    document.getElementById('personSt').style.color='#fa0';
  }
  
  ctx.restore();
  
  frameCount++;
  const now=Date.now();
  if(now-lastTime>1000){
    document.getElementById('fps').textContent=frameCount;
    frameCount=0;
    lastTime=now;
  }
}

function drawPath(){
  if(path.length<2)return;
  
  ctx.strokeStyle='#0f0';
  ctx.lineWidth=4;
  ctx.shadowColor='#0f0';
  ctx.shadowBlur=10;
  ctx.beginPath();
  
  path.forEach((segment,i)=>{
    if(i===0)ctx.moveTo(segment.x1,segment.y1);
    ctx.lineTo(segment.x2,segment.y2);
  });
  
  ctx.stroke();
  ctx.shadowBlur=0;
  
  path.forEach((segment,i)=>{
    const opacity=0.3+(i/path.length)*0.7;
    ctx.beginPath();
    ctx.arc(segment.x2,segment.y2,5,0,2*Math.PI);
    ctx.fillStyle=`rgba(0,255,0,${opacity})`;
    ctx.fill();
  });
}

setInterval(async()=>{
  if(espConnected&&espIP){
    try{
      const response=await fetch(`http://${espIP}/data`);
      const data=await response.json();
      document.getElementById('dist').textContent=data.distance.toFixed(1);
    }catch(err){}
  }
},1000);

window.onload=init;
</script>
</body>
</html>
